<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="stylesheet" href="index.css" type="text/css" />
</head>
<body>
<div id="res" class="hidden">
	<img id="player0L" src="res/player0.png" />
	<canvas id="player0R" from="player0L 0 48 256 48"
		transform="mirror:x"></canvas>
	<canvas id="bullet0" from="player0L 128 0 16 16"
		transform="rotate:{{range(180, 0, 10)}}"></canvas>
	<canvas id="bullet1" from="player0L 144 0 16 16"
		transform="rotate:{{range(90, 0, 15)}}"></canvas>
	<canvas id="onmyou" from="player0L 128 16 16 16"
		transform="rotate:{{range(360, 0, 20)}}"></canvas>
	<img id="etama2" src="res/etama2.png" />
	<img id="etama3" src="res/etama3.png" />
	<canvas id="lasers" from="etama3 0 16 256 16"
		transform="mirror:{{array(50)}}" stack="y"></canvas>
	<img id="etama4" src="res/etama4.png" />
	<img id="eff00" src="res/eff00.png" />
	<canvas id="effboss" from="eff00 16 48 16 16"
		transform="rotate:{{range(180, 0, 10)}}"></canvas>
	<canvas id="effbullet" from="player0L 128 32 16 16"
		transform="rotate:{{range(360, 0, 60)}}"></canvas>
	<canvas id="pslow" from="etama2 0 112 64 64"
		transform="rotate:{{range(90, 0, 6)}}"></canvas>
	<img id="stg1enm" src="res/stg1enm.png" />
	<img id="stg1enm2" src="res/stg1enm2.png" />
	<canvas id="stg1enm2R" from="stg1enm2 0 48 96 48" transform="mirror:x"></canvas>
	<img id="stg1bg" src="res/stg1bg.png" />
	<img id="front" src="res/front.png" />
	<canvas id="bombs" from="player0L 0 97 63 64"
		transform="colormask:White,DeepPink,DodgerBlue,SpringGreen"></canvas>
	<!-- -->
	<canvas id="mainbg_patt" from="front 0 224 32 32" bg-css=".play"></canvas>
	<canvas id="scbg1" from="front 80 224 16 16" bg-css=".scbg1"></canvas>
	<canvas id="scbg2" from="front 96 224 16 16" bg-css=".scbg2"></canvas>
	<!-- -->
	<canvas id="tree_pattL" from="stg1bg 0 48 64 128"
		transform="mirror:0,y" stack="y"></canvas>
	<canvas id="tree_pattR" from="tree_pattL"
		transform="mirror:x"></canvas>
	<script id="gen_treebg">
		(function(RES) {
			var cv = $e('treebg'),
				dc = getCanvasDC(cv);
			cv.width = parseInt($style(cv, 'width'));
			cv.height = parseInt($style(cv, 'height'));

			ieach([RES.tree_pattL, RES.tree_pattR], function mkRepeatTexture(i, patt) {
				var sw = patt.width,
					h = patt.height / 2,
					f = random(1),
					x = i == 0 ? 10 : cv.width - patt.width - 10,
					y = 0;
				while (y < cv.height) {
					var g = random(1);
						sy = (g > f ? f : 2 - f) * h,
						sh = Math.abs(g - f) * h;
					dc.drawImage(patt, 0, sy, sw, sh, x, y, sw, sh);

					f = g;
					y += sh;
				}
			});

			var rh = parseInt($style('.game', 'height'));
			dc.repeatSelf(0, cv.height - rh, cv.width, rh, 0, 0);
		})
	</script>
	<!-- -->
	<canvas id="ground_patt" from="stg1bg 0 0 64 32"></canvas>
	<canvas id="ground_pattX" class="ground_patt" from="stg1bg 64 0 16 16"></canvas>
	<canvas id="ground_patt0" class="ground_patt" from="stg1bg 64 0 16 16"></canvas>
	<canvas id="ground_patt1" class="ground_patt" from="stg1bg 80 0 16 16"></canvas>
	<canvas id="ground_patt2" class="ground_patt" from="stg1bg 96 0 32 16"></canvas>
	<canvas id="ground_patt3" class="ground_patt" from="stg1bg 64 16 16 16"></canvas>
	<canvas id="ground_patt4" class="ground_patt" from="stg1bg 80 16 28 16"></canvas>
	<canvas id="ground_patt5" class="ground_patt" from="stg1bg 108 16 20 16"></canvas>
	<canvas id="ground_tileB" from="stg1bg 128 0 64 18"></canvas>
	<canvas id="ground_tileT" from="ground_tileB" transform="rotate:180"></canvas>
	<canvas id="ground_brush0" from="stg1bg 208 48 48 16" transform="0,0"></canvas>
	<canvas id="ground_brush1" from="ground_brush0" transform="offset:0 0,16 0" stack="y"></canvas>
	<canvas id="ground_brush2" from="ground_brush1 0 0 48 32"></canvas>
	<script id="gen_groundbg">
		(function(RES) {
			var cv = $e('groundbg'),
				dc = getCanvasDC(cv),
				patt = RES.ground_patt;
			cv.width = parseInt($style(cv, 'width'));
			cv.height = parseInt($style(cv, 'height'));
			dc.fillWith(dc.createPattern(patt, 'repeat'));

			for (var y = 0; y < cv.height; y += patt.height) {
				var cx = random(0.3, 0.7) * cv.width,
					cy = random(patt.height) + y;
					sc = randin($('canvas.ground_patt'));
				dc.drawImage(sc, cx, cy);
			}

			var sc = RES.ground_tileT,
				brA = 'rgb(57, 49, 94)',
				brB = dc.createPattern(RES.ground_brush2, 'repeat'),
				py = 800, ph = 200;
			for (var x = 0, y = py; x < cv.width; x += sc.width, y -= sc.height) {
				dc.clearRect(x, y, sc.width, ph);
				dc.fillStyle = brA;
				dc.fillRect(x, y, sc.width, ph);
				dc.fillStyle = brB;
				dc.fillRect(x, y, sc.width, ph);
				dc.drawImage(RES.ground_tileT, x, y);
				dc.drawImage(RES.ground_tileB, x, y + ph - sc.height);
			}

			var bg = $e('treebg'),
				hw = bg.width / 2,
				dw = bg.width * 0.1;
			dc.globalAlpha = 0.4;
			dc.drawImage(bg, 0, 0, hw, bg.height, dw, cv.height - bg.height, hw, bg.height);
			dc.drawImage(bg, hw, 0, hw, bg.height, hw-dw, cv.height - bg.height, hw, bg.height);
			dc.globalAlpha = 1;

			var rh = parseInt($style('.game', 'height'));
			dc.repeatSelf(0, cv.height - rh, cv.width, rh, 0, 0);
		})
	</script>
	<!-- -->
	<canvas id="logo_patt" from="front 128 128 128 128" bg-css=".logo"></canvas>
	<!-- -->
	<script id="gen_bgcss">
		(function(RES) {
			/*
			 * canvas.toDataURL() will not work in chrome when the html file is opened in a local disk
			 * see http://stackoverflow.com/questions/10187306/canvas-todataurl-throws-security-exception-despite-image-being-local
			 */
			ieach($('canvas[bg-css]'), function(i, cv, ss) {
				var s = $attr(cv, 'bg-css'),
					r = 'background: url(' + cv.toDataURL() + ')';
				ss.addRule ? ss.addRule(s, r) : ss.insertRule(s+' {'+r+'}', ss.cssRules.length);
			}, document.styleSheets[0]);
		})
	</script>
	<!-- -->
	<script id="frames">
		(function(RES) {
			var _t = {};

			_t.Player0 = array(4, function(i) {
				return extend({ res:'player0L', sy: 0, sw:32, sh:48, w:32, h:48 }, { sx:32*i });
			});
			lastOfArray(_t.Player0).next = 0;
			_t.PlayerL = array(7, function(i) {
				return extend({ res:'player0L', sy:48, sw:32, sh:48, w:32, h:48 }, { sx:32*i });
			});
			lastOfArray(_t.PlayerL).next = 4;
			_t.PlayerR = array(7, function(i) {
				return extend({ res:'player0R', sy:0, sw:32, sh:48, w:32, h:48 }, { sx:255-32*(i+1) });
			});
			lastOfArray(_t.PlayerR).next = 4;

			ieach([_t.PlayerL, _t.PlayerR], function(i, ls, ls0) {
				ls.reset_index = ls0.length;
				ieach(range(3).reverse(), function(x, i) {
					ls0.push(extend({}, ls[i]));
				});
				lastOfArray(ls0).next = 0;
			}, _t.Player0);

			_t.Bullet0 = array(RES.bullet0.width/16, function(i) {
				return extend({ res:'bullet0', sy:0, sw:16, sh:16, w:16, h:16 }, { sx:16*i });
			});
			_t.Bullet1 = array(RES.bullet1.width/16, function(i) {
				return extend({ res:'bullet1', sy:0, sw:16, sh:16, w:16, h:16 }, { sx:16*i });
			});
			_t.BulletD = [
				{ res:'player0L', sx:160, sy: 0, sw:16, sh:16, w:16, h:16 },
				{ res:'player0L', sx:176, sy: 0, sw:16, sh:16, w:16, h:16 },
			];
			_t.Onmyou = array(RES.onmyou.width/16, function(i) {
				return extend({ res:'onmyou', sy:0, sw:16, sh:16, w:16, h:16 }, { sx:16*i });
			});
			_t.OnmyouR = array(RES.onmyou.width/16, function(i) {
				return extend({ res:'onmyou', sy:0, sw:16, sh:16, w:16, h:16 }, { sx:RES.onmyou.width-16-16*i });
			});
			_t.PSlow = array(RES.pslow.width/64, function(i) {
				return extend({ res:'pslow', sy:0, sw:64, sh:64, w:64, h:64 }, { sx:64*i });
			});
			_t.Shield = array(RES.bombs.width/63, function(i) {
				return extend({ res:'bombs', sy:0, sw:60, sh:60, w:120, h:120 }, { sx:63*i });
			});

			ieach(['Drops', 'Lasers', 'TamaA', 'TamaB', 'LongA', 'LongB', 'LongC'], function(i, k) {
				_t[k] = array(16, function(j) {
					return { res:'etama3', sx:16*j, sy:i*16, sw:16, sh:16, w:16, h:16, rotate:k.indexOf('Long')==0 }
				});
			});
			_t.TamaSmall = array(5, function(i) {
				return { res:'etama3', sx:16*(i+4), sy:112, sw:16, sh:16, w:16, h:16 }
			})
			_t.TamaDead = array(5, function(i) {
				return { res:'etama3', sx:16*(i+9), sy:112, sw:16, sh:16, w:16, h:16 }
			})
			_t.TamaLarge = array(8, function(i) {
				return { res:'etama3', sx:32*i, sy:128, sw:32, sh:32, w:32, h:32 }
			});
			_t.TamaSmallX = array(8, function(i) {
				return { res:'etama3', sx:8*i+128, sy:208, sw:8, sh:8, w:8, h:8 }
			});
			_t.TamaSmallY = array(8, function(i) {
				return { res:'etama3', sx:8*i+128, sy:208+8, sw:8, sh:8, w:8, h:8 }
			});
			_t.TamaFire = array(8, function(i) {
				return { res:'etama3', sx:32*i, sy:257-32, sw:32, sh:32, w:32, h:32 }
			});
			_t.TamaColorNew = {
				k: _t.TamaFire[0],
				r: _t.TamaFire[1],
				m: _t.TamaFire[2],
				b: _t.TamaFire[3],
				c: _t.TamaFire[4],
				g: _t.TamaFire[5],
				y: _t.TamaFire[6],
				w: _t.TamaFire[7],
			};
			_t.TamaColorDead = {
				k: _t.TamaDead[0],
				r: _t.TamaDead[1],
				m: _t.TamaDead[1],
				b: _t.TamaDead[2],
				c: _t.TamaDead[2],
				g: _t.TamaDead[3],
				y: _t.TamaDead[4],
				w: _t.TamaDead[0],
			}
			_t.LaserLong = array(16, function(j) {
				return { res:'lasers', sx:16*j, sy:0, sw:16, sh:RES.lasers.height, w:16, h:RES.lasers.height };
			});

			ieach([0, 128], function(i, x) {
				ieach([0, 32, 64], function(j, y) {
					_t['Enemy'+i+j] = array(4, function(i) {
						return extend({ res:'stg1enm', sy:y, sw:32, sh:32, w:32, h:32 }, { sx:x+32*i });
					});
				});
			});
			_t.EnemyX = array(8, function(i) {
				return extend({ res:'stg1enm', sy:255-48, sw:32, sh:48, w:32, h:48 }, { sx:32*i });
			});

			_t.Boss = [{ res:'stg1enm2', sx:128, sy:0, sw:32, sh:48, w:32, h:48 }];
			lastOfArray(_t.Boss).next = 0;

			_t.Boss.reset_index = _t.Boss.length;
			array(5, function(i) {
				_t.Boss.push(extend({ res:'stg1enm2', sy:0, sw:32, sh:48, w:32, h:48 }, { sx:128-32*i }));
			});
			array(5, function(i) {
				_t.Boss.push(extend({ res:'stg1enm2', sy:0, sw:32, sh:48, w:32, h:48 }, { sx:32*i }));
			});
			lastOfArray(_t.Boss).next = 0;

			_t.BossL = array(3, function(i) {
				return extend({ res:'stg1enm2', sy:48, sw:32, sh:48, w:32, h:48 }, { sx:32*i });
			});
			_t.BossL.unshift({ res:'stg1enm2', sx:160, sy:0, sw:32, sh:48, w:32, h:48 });

			_t.BossR = array(3, function(i) {
				return extend({ res:'stg1enm2R', sy:0, sw:32, sh:48, w:32, h:48 }, { sx:32*i });
			});
			_t.BossR.push({ res:'stg1enm2', sx:192, sy:0, sw:32, sh:48, w:32, h:48 });

			_t.EffBullet = array(RES.effbullet.width/16, function(i) {
				return { res:'effbullet', sx:i*16, sy:0, sw:16, sh:16, w:16, h:16 };
			});
			_t.EffBoss = array(RES.effboss.width/16, function(i) {
				return { res:'effboss', sx:i*16, sy:0, sw:16, sh:16, w:16, h:16 };
			});
			stayLastFrame(_t.EffBoss);
			_t.EffEnemy = ieach([32,42,52,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26], function(i, d, ls) {
				ls.push(extend({ res:'eff00', sx:32, sy:0, sw:32, sh:32, rotate:-i*0.5 }, { w:d, h:d }));
			}, []);
			stayLastFrame(_t.EffEnemy);
			_t.EffEnemy2 = ieach([32,42,52,62,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26], function(i, d, ls) {
				ls.push(extend({ res:'eff00', sx:64, sy:0, sw:32, sh:32 }, { w:d, h:d }));
			}, []);
			stayLastFrame(_t.EffEnemy2);
			_t.EffPlayer = ieach([32,42,52,62,67,72,76,80,83,86,89,92,95,98,101,104,107,110,113,116,119,122], function(i, d, ls) {
				ls.push(extend({ res:'eff00', sx:0, sy:0, sw:32, sh:32 }, { w:d*1.5, h:d*1.5 }));
			}, []);
			stayLastFrame(_t.EffPlayer);
			ieach(['EffPiece', 'EffPieceR', 'EffPieceG', 'EffPieceB'], function(i, k) {
				_t[k] = array(4, function(j) {
					return { res:'eff00', sx:i*64+j*16, sy:32, sw:16, sh:16, w:16, h:16 };
				});
			});

			return _t;
		})
	</script>
	<!-- -->
	<img id="ascii" src="res/ascii.png" />
	<canvas id="ascii_yellow" from="ascii"
		transform="colormap:l->rgb(255,255,64)"></canvas>
	<script id="fontmap">
		(function(RES) {
			var _t = {
				cw: 16,
				ch: 16,
			}
			ieach([
				' !"#$%&\'()*+,-./',
				'0123456789:;<=>?',
				'@ABCDEFGHIJKLMNO',
				'PQRSTUVWXYZ[`]`_',
				' abcdefghijklmno',
				'pqrstuvwxyz(|)~`',
			], function(i, s) {
				ieach(s, function(j, c) {
					_t[c] = {
						x: j * _t.cw,
						y: i * _t.ch + 32,
					};
				});
			});
			return _t;
		})
	</script>
	<!-- -->
	<canvas id="num" from="ascii 0 48 256 16"></canvas>
	<canvas id="num0" from="num"
		transform="colormap:l->rgb(123,192,249)"></canvas>
	<canvas id="num1" from="num"
		transform="colormap:l->rgb(155,120,240)"></canvas>
	<canvas id="num2" from="num"
		transform="colormap:l->rgb(224,128,192)"></canvas>
	<canvas id="num3" from="num"
		transform="colormap:l->rgb(255,64,64)"></canvas>
	<script id="nummap">
		(function(RES) {
			var _t = {
				cw: 16,
				ch: 16,
			}
			ieach('0123456789', function(j, c) {
				_t[c] = {
					x: j * _t.cw,
					y: 0,
				};
			});
			return _t;
		})
	</script>
	<script id="nummap_small">
		(function(RES) {
			var _t = {
				cw: 8,
				ch: 8,
			}
			ieach('0123456789', function(j, c) {
				_t[c] = {
					x: j * _t.cw,
					y: 0,
				};
			});
			return _t;
		})
	</script>
	<!-- -->
	<script id="path">
		(function(RES) {
			var _t = {};
			var px = [ 289.0000, 291.4871, 293.9646, 296.5264, 299.1865, 301.8095, 304.3419, 306.5720, 308.3281, 309.4115, 309.5326, 307.9323, 304.2901, 298.9275, 292.1941, 284.0961, 275.0194, 265.3390, 254.5708, 242.6049, 230.7947, 220.4594, 211.7473, 203.7928, 195.1450, 184.0242, 170.3047, 156.2471, 143.8316, 133.3488, 124.9875, 118.7166, 112.8136, 106.7639, 101.3582, 96.6113, 91.5299, 86.1616, 80.6570, 75.0152, 69.6112, 65.5902, 63.1142, 61.4212, 60.0489, 59.2489, 59.0167, 59.0271, 59.3274, 60.3901, 62.8355, 66.5539, 71.1331, 76.1267, 81.5210, 86.8354, 91.7015, 96.1465, 100.4320, 104.7082,],
				py = [ 46.0000, 52.4794, 59.4428, 67.3262, 75.9989, 85.1050, 94.3881, 103.3935, 112.0092, 120.6787, 129.7307, 139.3384, 148.8354, 157.0588, 163.2260, 167.5118, 169.9836, 170.8704, 170.8188, 170.2619, 169.2804, 167.8313, 165.6173, 162.4749, 158.7617, 155.3717, 153.1626, 152.5871, 154.1525, 157.9328, 163.2417, 169.2466, 175.9969, 183.0085, 189.9010, 196.9946, 205.1844, 214.3816, 224.4499, 235.6024, 247.7896, 260.0121, 272.7309, 287.0547, 302.7754, 319.1230, 335.2127, 350.5645, 365.5082, 380.8962, 397.0706, 413.3549, 429.7201, 446.1817, 462.4964, 477.5713, 490.6602, 501.7282, 511.5860, 520.6555,];
			_t.s0A1 = ieach(px, function(i, v, d) {
				d.push({x:px[i]-32, y:py[i]-36, v:0.12});
			}, []);
			_t.s0A1.push({fy:2, v:0.12});
			_t.s0A2 = ieach(_t.s0A1, function(i, v, d) {
				d.push({x:GAME.rect.r+GAME.rect.l-v.x, y:v.y, v:v.v});
			}, []);
			_t.s0A2.push({fy:2, v:0.12});
			return _t;
		})
	</script>
	<script type="text/html" id="st_ask_continue">以下是原创内容，继续吗？</script>
	<script type="text/html" id="st_bomb_sc">灵符「梦想封印」</script>
	<script type="text/html" id="st_stg1_sc1">夜符「夜雀」</script>
	<script type="text/html" id="st_stg1_sc2">闇符「境界线」</script>
	<script type="text/html" id="st_stg1_title">梦幻夜行绘卷  ~ Mystic Flier</script>
	<script type="text/html" id="st_diag1">感觉真不错呢</script>
	<script type="text/html" id="st_diag2">每次都在白天出来所以妖怪很少见<br />所以，这次才试着在夜里出来的……</script>
	<script type="text/html" id="st_diag3">不过该往哪边走都搞不清楚了<br />这么暗</script>
	<script type="text/html" id="st_diag4">但是……</script>
	<script type="text/html" id="st_diag5">夜里的境内还真够浪漫呢<br />（←轻松状）</script>
	<script type="text/html" id="st_diag6">说的就是嘛～<br />还会出现妖怪，真是受不了啊</script>
	<script type="text/html" id="st_diag7">呃，<br />你谁啊？</script>
	<script type="text/html" id="st_diag8">刚刚不是见过了吗<br />你难不成是鸟目吗？</script>
	<script type="text/html" id="st_diag9">人类在一片漆黑的地方<br />当然看不清东西啊</script>
	<script type="text/html" id="st_diag10">是吗？我感觉好像看到了<br />只在夜里才活动的人呢</script>
	<script type="text/html" id="st_diag11">那种人你就算抓住吃了也<br />无所谓啊</script>
	<script type="text/html" id="st_diag12">是—这样吗—</script>
	<script type="text/html" id="st_diag13">不过，你很碍事呢</script>
	<script type="text/html" id="st_diag14">在我眼前的就是吃了也没关系的人类？</script>
	<script type="text/html" id="st_diag15">良药苦口<br />这句话你有没有听过？</script>
	<script type="text/html" id="st_diag16">不过就算是良药<br >如果不喝了试试的话谁又知道效果呢</script>
	<script type="text/html" id="st_diag17">...</script>
	<script type="text/html" id="st_diag18">咦，你不是该退场了吗？</script>
	<script type="text/html" id="st_diag19">是—这样吗—</script>
	<script type="text/html" id="st_diag20">真是麻烦的妖怪...还想早点回去喝茶呢（←45度抬头望向右上角）</script>
	<script type="text/html" id="st_diag21">怕麻烦的话，点那个红叉好像没错呢</script>
	<script type="text/html" id="st_diag22">哈？</script>
	<script type="text/html" id="st_diag23">就算今天移动有点迟钝，阴阳玉的声音也比较奇怪，退治掉你还是没问题的哦</script>
	<script type="text/html" id="st_diag24">把我退治掉，就没人陪你玩了...<br />听说人类都是很怕寂寞的，所以...</script>
	<script type="text/html" id="st_diag25">还是让我把你吃掉，变成一心同体吧！</script>
	<script type="text/html" id="st_diag26">想和我一心同体的妖怪，从神社门口开始排，到你的位置大概会在人间之里吧</script>
	<script type="text/html" id="st_diag27">不过如果给赛钱的话，是可以走特殊通道的呢</script>
	<script type="text/html" id="st_diag28">不用排队的啦，都说了这个世(you)界(xi)只有我和你两个角色而已...</script>
	<script type="text/html" id="st_diag29">在说梦话吗？我出门的时候可是还看到魔里沙的</script>
	<script type="text/html" id="st_diag30">啊，那个魔里沙就是个立绘而已...<br />连对话都没有...</script>
	<script type="text/html" id="st_diag31">说起来确实没有打招呼呢...</script>
	<script type="text/html" id="st_diag32">不管了，那种事情还是先把你打倒，然后再去确认吧</script>
	<script type="text/html" id="st_diag33">不利用这个世界的特殊规则的话，要打倒我是不可能的哦</script>
	<!-- sfx -->
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_graze" src="res/se_graze.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_pldead00" src="res/se_pldead00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_cancel00" src="res/se_cancel00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_invalid" src="res/se_invalid.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_ok00" src="res/se_ok00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_select00" src="res/se_select00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_pause" src="res/se_pause.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_plst00" src="res/se_plst00.mp3" replay-queue="4" replay-time="0.08"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_item00" src="res/se_item00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_cat00" src="res/se_cat00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_gun00" src="res/se_gun00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_damage00" src="res/se_damage00.mp3" replay-queue="4"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_enep00" src="res/se_enep00.mp3" replay-queue="4"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_enep01" src="res/se_enep01.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_power1" src="res/se_power1.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_tan00" src="res/se_tan00.mp3" replay-queue="4"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_tan01" src="res/se_tan01.mp3" replay-queue="4"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_tan02" src="res/se_tan02.mp3" replay-queue="4"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_lazer00" src="res/se_lazer00.mp3"></audio>
	<audio preload oncanplaythrough="this.complete=true" class="se" id="se_timeout" src="res/se_timeout.mp3"></audio>
	<!--- bgms -->
	<audio preload oncanplay="this.complete=true" loop class="bgm" id="bgm_title" src="res/bgm_title.mp3"></audio>
	<audio preload oncanplay="this.complete=true" loop class="bgm" id="bgm_stg1a" src="res/bgm_stg1a.mp3"></audio>
	<audio preload oncanplay="this.complete=true" loop class="bgm" id="bgm_stg1b" src="res/bgm_stg1b.mp3"></audio>
</div>
<div class="main">
	<div class="screen play absolute ui"
		ui-show="GAME.state == GAME.states.RUNNING || GAME.state == GAME.states.PAUSE ||
			GAME.state == GAME.states.ENDED">
		<div class="game absolute no-overflow" style="z-index:0">
			<!-- add no-overflow to fix issue in Firefox -->
			<div class="game-size absolute bgimg no-overflow"
				id="bg0">
				<canvas class="ui-obj bg1 game-size" style="height:2400px"
					id="groundbg" bg-speed="0.01"></canvas>
				<div class="ui-obj bg1"
					style="height:350px;background:linear-gradient(rgba(0,0,0,0.8),transparent);-webkit-transform:translate3d(0,0,0.1px)"></div>
			</div>
			<div class="game-size absolute bgimg no-overflow"
				id="bg1">
				<canvas class="ui-obj bg1 game-size" style="height:1000px;"
					id="treebg" bg-speed="0.015"></canvas>
				<div class="ui-obj bg1"
					style="height:300px;background:linear-gradient(rgba(0,0,0,0.6),transparent);-webkit-transform:translate3d(0,0,0.1px)"></div>
			</div>
			<div class="game-size absolute bgimg">
				<div class="ui-obj bossbg anim-in-01s"
					style="background:url(res/eff01.png);opacity:0"></div>
				<div class="ui-obj bombbg anim-in-01s"
					style="background:rgba(0,0,0,0.6);opacity:0"></div>
			</div>
		</div>
		<canvas class="game absolute" id="canv"></canvas>
		<div class="game absolute no-overflow diag">
			<div class="fl sc">
				<div class="face f0a f2 sc-bomb"></div>
				<span class="text scbg1"></span>
			</div>
			<div class="fr sc">
				<div class="face f3b sc-boss"></div>
				<span class="text scbg2"></span>
			</div>
			<div class="fl dg">
				<div class="face f0a"></div>
				<div class="face f0a f2"></div>
				<div class="face f0b"></div>
				<div class="face f0b f2"></div>
				<div class="face f0c"></div>
				<div class="face f0c f2"></div>
			</div>
			<div class="fr dg">
				<div class="face f3a"></div>
				<div class="face f3a f2"></div>
				<div class="face f3b"></div>
				<div class="face f3b f2"></div>
			</div>
			<div class="ft dg">
				<div class="text"></div>
			</div>
		</div>
		<div class="game pause mask absolute ui" ui-show="GAME.state == GAME.states.PAUSE">
			<div class="menu menu-pause-text"></div>
			<form class="menu-pause ui" eval-radios
				ui-focus="GAME.state == GAME.states.PAUSE"
				onkeyup="checkFormKey(event, this)" onescape="changeGameState('RUNNING'); return false">
				<div class="menu-line">
					<input type="radio" value="changeGameState('RUNNING')" />
					<label class="menu menu-pause-continue"></label>
				</div>
				<div class="menu-line">
					<input type="radio" value="changeGameState('TITLE')" />
					<label class="menu menu-pause-title"></label>
				</div>
				<div class="menu-line">
					<input type="radio" value="window.close()" />
					<label class="menu menu-pause-quit"></label>
				</div>
				<input style="width:0px;opacity:0;" type="submit" />
			</form>
		</div>
		<div class="info absolute">
			<div class="line">
				<div class="label"><div class="label-max-point"></div></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 1)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 2)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 3)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 4)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 5)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 6)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 7)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 8)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.max_point+1e9, 9)" ui-bind-attr="this.className"></div>
			</div>
			<div class="line">
				<div class="label"><div class="label-point"></div></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 1)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 2)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 3)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 4)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 5)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 6)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 7)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 8)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.point+1e9, 9)" ui-bind-attr="this.className"></div>
			</div>
			<div class="line-sep"></div>
			<div class="line">
				<div class="label"><div class="label-player"></div></div>
				<div class="ui player" ui-show="STATICS.player > 0"></div>
				<div class="ui player" ui-show="STATICS.player > 1"></div>
				<div class="ui player" ui-show="STATICS.player > 2"></div>
				<div class="ui player" ui-show="STATICS.player > 3"></div>
				<div class="ui player" ui-show="STATICS.player > 4"></div>
				<div class="ui player" ui-show="STATICS.player > 5"></div>
				<div class="ui player" ui-show="STATICS.player > 6"></div>
			</div>
			<div class="line">
				<div class="label"><div class="label-bomb"></div></div>
				<div class="ui bomb" ui-show="STATICS.bomb > 0"></div>
				<div class="ui bomb" ui-show="STATICS.bomb > 1"></div>
				<div class="ui bomb" ui-show="STATICS.bomb > 2"></div>
				<div class="ui bomb" ui-show="STATICS.bomb > 3"></div>
				<div class="ui bomb" ui-show="STATICS.bomb > 4"></div>
				<div class="ui bomb" ui-show="STATICS.bomb > 5"></div>
				<div class="ui bomb" ui-show="STATICS.bomb > 6"></div>
			</div>
			<div class="line-sep"></div>
			<div class="line-small">
				<div class="power-bar absolute ui" ui-bind="STATICS.power+'px'" ui-bind-attr="this.style.width"></div>
				<div class="label"><div class="label-power"></div></div>
				<div class="ui float-left" ui-show="STATICS.power < 128">
					<div class="ui" ui-bind="'ui num n'+getNum(STATICS.power, 0)" ui-bind-attr="this.className"></div>
					<div class="ui" ui-bind="'ui num n'+getNum(STATICS.power, 1)" ui-bind-attr="this.className"></div>
					<div class="ui" ui-bind="'ui num n'+getNum(STATICS.power, 2)" ui-bind-attr="this.className"></div>
				</div>
				<div class="ui power-max" ui-show="STATICS.power >= 128"></div>
			</div>
			<div class="line-small">
				<div class="label"><div class="label-graze"></div></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 0)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 1)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 2)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 3)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 4)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 5)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 6)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 7)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.graze, 8)" ui-bind-attr="this.className"></div>
			</div>
			<div class="line-small">
				<div class="label"><div class="label-dot"></div></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 0)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 1)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 2)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 3)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 4)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 5)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 6)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 7)" ui-bind-attr="this.className"></div>
				<div class="ui" ui-bind="'ui num n'+getNum(STATICS.dot, 8)" ui-bind-attr="this.className"></div>
			</div>
		</div>
		<div class="logo absolute"></div>
		<div class="logo-text absolute">
			<div class="tr">
				<div class="td"><div class="font fa"></div></div>
				<div class="td"><div class="font fb"></div></div>
				<div class="td"></div>
			</div>
			<div class="tr">
				<div class="td"></div>
				<div class="td"><div class="font fc"></div></div>
				<div class="td"></div>
			</div>
			<div class="tr">
				<div class="td"></div>
				<div class="td"><div class="font fd"></div></div>
				<div class="td"><div class="font fe"></div></div>
			</div>
		</div>
		<div class="fps absolute" style="color:white">
			<div>fps: <span class="ui" ui-bind="(+GAME.fps).toFixed(2)+' / '+GAME.tick"></span></div>
		</div>
	</div>
	<div class="screen select absolute no-overflow ui"
		ui-show="GAME.state == GAME.states.SELECT || GAME.state == GAME.states.SELECT_DIFF ||
			GAME.state == GAME.states.SELECT_CHAR || GAME.state == GAME.states.SELECT_BOMB">
		<form class="select-diff absolute ui" eval-radios
			ui-focus="GAME.state == GAME.states.SELECT_DIFF"
			onkeyup="checkFormKey(event, this)" onescape="changeGameState('TITLE')">
			<div class="select-title"></div>
			<div class="menu-line">
				<input type="radio" value="changeGameState('SELECT_CHAR')" />
				<label class="menu menu-diff-easy"></label>
			</div>
			<div class="menu-line">
				<input type="radio" value="changeGameState('SELECT_CHAR')" />
				<label class="menu menu-diff-normal"></label>
			</div>
			<div class="menu-line">
				<input type="radio" value="changeGameState('SELECT_CHAR')" />
				<label class="menu menu-diff-hard"></label>
			</div>
			<div class="menu-line">
				<input type="radio" value="changeGameState('SELECT_CHAR')" />
				<label class="menu menu-diff-lunatic"></label>
			</div>
		</form>
		<form class="select-char absolute ui" eval-radios
			ui-focus="GAME.state == GAME.states.SELECT_CHAR"
			onkeyup="checkFormKey(event, this)" onescape="changeGameState('SELECT_DIFF')">
			<div class="select-title"></div>
			<div class="menu-line absolute">
				<input type="radio" value="changeGameState('SELECT_BOMB')" />
				<label class="menu menu-char-reimu">
					<img src="res/slpl00a.png" />
					<img src="res/slpl00b.png" />
				</label>
			</div>
			<div class="menu-line absolute">
				<input type="radio" />
				<label class="menu menu-char-marisa">
					<img src="res/slpl01a.png" />
					<img src="res/slpl01b.png" />
				</label>
			</div>
		</form>
		<form class="select-bomb absolute ui" eval-radios
			ui-focus="GAME.state == GAME.states.SELECT_BOMB"
			onkeyup="checkFormKey(event, this)" onescape="changeGameState('SELECT_CHAR')">
			<div class="select-title"></div>
			<div class="menu-line">
				<input type="radio" value="loadAndStart()" />
				<label class="menu menu-bomb-a"></label>
			</div>
			<div class="menu-line">
				<input type="radio" />
				<label class="menu menu-bomb-b"></label>
			</div>
		</form>
	</div>
	<div class="screen title absolute no-overflow ui"
		ui-show="GAME.state == GAME.states.LOADING || GAME.state == GAME.states.TITLE ||
			GAME.state == GAME.states.MENU || GAME.state == GAME.states.SELECT">
		<div class="title-text absolute anim-in-04s">
			<div class="font fa"></div>
			<div class="font fb"></div>
			<div class="font fc"></div>
			<div class="font fd"></div>
			<div class="font fe"></div>
			<div class="title-eng absolute">
				<div class="text text1"></div>
				<div class="text text2"></div>
			</div>
		</div>
		<form class="absolute ui" eval-radios
			ui-show="GAME.state == GAME.states.TITLE"
			ui-focus="GAME.state == GAME.states.TITLE"
			onkeyup="checkFormKey(event, this)">
			<input type="radio" value="changeGameState('MENU')" />
		</form>
		<form class="menu-title ui" eval-radios
			ui-focus="GAME.state == GAME.states.MENU"
			onkeyup="checkFormKey(event, this)" onescape="checkRadio($i('input', $i('.menu-title-quit').parentNode))">
			<div class="menu-line">
				<input type="radio" value="changeGameState('SELECT_DIFF')" />
				<label class="menu menu-title-start"></label>
			</div>
			<div class="menu-line">
				<input type="radio" disabled />
				<label class="menu menu-title-extra-start"></label>
			</div>
			<div class="menu-line">
				<input type="radio" />
				<label class="menu menu-title-practice-start"></label>
			</div>
			<div class="menu-line">
				<input type="radio" />
				<label class="menu menu-title-replay"></label>
			</div>
			<div class="menu-line">
				<input type="radio" />
				<label class="menu menu-title-score"></label>
			</div>
			<div class="menu-line">
				<input type="radio" />
				<label class="menu menu-title-music-room"></label>
			</div>
			<div class="menu-line">
				<input type="radio" />
				<label class="menu menu-title-option"></label>
			</div>
			<div class="menu-line">
				<input type="radio" value="window.close()" />
				<label class="menu menu-title-quit"></label>
			</div>
			<input style="width:0px;opacity:0;" type="submit" />
		</form>
	</div>
	<div class="screen loading absolute ui"
		ui-show="GAME.state == GAME.states.LOADING">
		<div style="margin:20px">
			<br />
			<br />
			<br />
			<br />
			<h4>
				这个网页游戏是东方红魔乡的部分游戏内容的复刻。<br />
				<br />
				由于本人对弹幕游戏的理解问题和技术力的限制，不可避免地存在各种与原作不符的操作和设定，可能给您带来不好的游戏体验请注意。<br />
				有少量带有原创设定的内容，请注意游戏过程中的提示。<br />
				本游戏与上海爱丽丝幻乐团没有任何关系，原作品的版权归ZUN所有。<br />
				请勿将本游戏用于任何商业用途。
			</h4>
			<button class="ui hidden" ui-show="RES.process == 1" onclick="checkStart()" style="font-size:100%;padding:0.5em">同意点此</button>
			<h3 class="ui" ui-show="RES.process < 1">loading <span class="ui" ui-bind="(RES.process*100).toFixed(1)+'%'">...</span></h3>
		</div>
		<form class="absolute ui" eval-radios
			ui-focus="GAME.state == GAME.states.LOADING"
			onkeyup="checkFormKey(event, this)">
			<input type="radio" value="checkStart()" />
		</form>
	</div>
</div>
<script src="game.js"></script>
<script>
ieach($('form[eval-radios]'), function(i, e) {
	e.action = 'javascript:evalRadioVal("eval_radio'+i+'")';
	ieach($('input[type="radio"]', e), function(j, r) {
		r.name = 'eval_radio'+i;
	});
});
ieach($('input[type="radio"]'), function(i, v) {
	var n = v.nextElementSibling;
	if (n && n.tagName == 'LABEL' && !v.id) {
		n.setAttribute('for', v.id = 'radio'+i);
		n.addEventListener('mouseup', function(e) {
			// have to wait before radios changed
			setTimeout(function() {
				v.form.submit();
			}, 10);
		});
	}
});
ieach($('.ui-obj'), function(i, v) {
	v.className += ' ui';
	v.setAttribute('ui-show', 'this.object && !this.object.finished');
});

function lastOfArray(ls) {
	return ls[ls.length - 1];
}
function stayLastFrame(fs) {
	lastOfArray(fs).next = fs.length - 1;
}

function checkActiveRadios() {
	var ls = ieach($('input[type="radio"]'), function(i, v, d) {
		if (v.scrollHeight)
			d.push(v);
	}, []);
	var r = ieach(ls, function(i, v) {
		if (v.checked)
			return v;
	}, ls[0]);
	if (r) checkRadio(r);
}

function checkFormKey(e, f) {
	if (e.which == 'Z'.charCodeAt(0)) {
		f.submit();
	}
	else if (e.which == 27) {
		var fn = $attr(f, 'onescape');
		if (fn && Function(fn)() === false)
			e.stopPropagation();
		RES.se_cancel00.replay();
	}
	else {
		RES.se_select00.replay();
	}
}

function getBGM() {
	if (GAME.state >= GAME.states.TITLE && GAME.state <= GAME.states.SELECT_BOMB)
		return RES.bgm_title;
	else if (GAME.state == GAME.states.RUNNING)
		return GAME.bgm_running;
}

function setAudioVolume(s, v) {
	ieach($(s), function(i, e) {
		e.volume = v;
	});
}

function checkRadio(elem) {
	elem.checked = true;
	elem.focus();
}

function getRadioVal(ls) {
	return ieach(ls, function(i, v) {
		if (v.checked) return v.value;
	});
}

function evalRadioVal(name) {
	try {
		eval(getRadioVal($('input[name="'+name+'"]')));
		RES.se_ok00.replay();
	}
	catch(e) {
		RES.se_invalid.replay();
	}
}

function getNum(n, i) {
	return (n + '').substr(i, 1);
}

function getCanvasDC(cv) {
	var dc = cv.getContext('2d');
	dc.fillWith = function(patt) {
		if (patt)
			dc.fillStyle = patt;
		dc.fillRect(0, 0, cv.width, cv.height);
	};
	dc.repeatSelf = function(sx, sy, sw, sh, x, y, w, h) {
		w = w || sw;
		h = h || sh;
		dc.clearRect(x, y, w, h);
		dc.drawImage(cv, sx, sy, sw, sh, x, y, w, h);
	};
	return dc;
}

function changeGameState(k) {
	function set_delay(s, t) {
		setTimeout(function() {
			GAME.state = s;
		}, t);
	}
	function get_group(s) {
		if (s == c.LOADING || s == c.TITLE || s == c.MENU)
			return 0;
		else if (s == c.SELECT || s == c.SELECT_DIFF || s == c.SELECT_CHAR || s == c.SELECT_BOMB)
			return 1;
	}
	var c = GAME.states;
		s0 = GAME.state;
		s = c[k];
	if (get_group(s) !== get_group(s0)) {
		GAME.state = GAME.states.SELECT;
		set_delay(s, 500);
	}
	else {
		GAME.state = s;
	}
}

function loadAndStart() {
	GAME.load(tl, hook);
	GAME.start('init');
}

function checkStart() {
	GAME.ready = true;
	if (RES.process == 1)
		changeGameState('TITLE');
}

setAudioVolume('audio.se', 0.2);
setAudioVolume('audio.bgm', 0.5);

GAME.state = GAME.states.LOADING;
RES.check();

setInterval(function() {
	if (GAME.state != GAME.states.RUNNING) {
		var f = $i('input:focus');
		if (!f || !f.scrollHeight)
			checkActiveRadios();
	}
	var bgm = getBGM();
	if (GAME.bgm !== bgm) {
		if (GAME.bgm)
			GAME.bgm.pause();
		if (GAME.bgm = bgm) {
			GAME.bgm.pause();
			GAME.bgm.play();
		}
	}
	// remove selection highlight for stubborn Firefox
	window.getSelection().removeAllRanges();
}, 300);

</script>
</body>
</html>
